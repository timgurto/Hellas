<html>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<head>
    <link href="style.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <h1>Hellas server</h1>

    <h2>Stats</h2>
    <p><span class="heading"> Version:</span> <span id="version" class="data" /></p>
    <p><span class="heading"> Uptime:</span> <span id="time" class="data" /></p>
    
    <h2>Users</h2>
    <table id="users" >
    <tr>
        <td class="heading"></td>
        <td class="heading">Name</td>
        <td class="heading">Offline/online</td>
        <td class="heading">Total played</td>
        <td class="heading">Class</td>
        <!--td class="heading">XP</td-->
        <td class="heading">City</td>
        <td class="heading">Health</td>
        <td class="heading">Energy</td>
        <td class="heading">Location</td>
        <td class="heading">Gear</td>
        <td class="heading">Inventory</td>
        <td class="heading">Expoloration</td>
        <td class="heading">Quests</td>
        <td class="heading">Recipes</td>
        <td class="heading">Constructions</td>
    </tr>
    </table>
</body>

<script type="text/javascript" src="stats.js"></script>
<script type="text/javascript">
    function make2Digits(n){
        return ("0" + n).slice(-2)
    }

    function timeDisplay(ms){
        var s = Math.round(ms/1000);
        var m = Math.floor(s/60); s = s % 60;
        var h = Math.floor(m/60); m = m % 60;
        var d = Math.floor(h/24); h = h % 24;
        
        var formattedTime = "";
        if (d != 0)
            formattedTime += d + "d ";
        if (d != 0 || h != 0)
            formattedTime += h + "h ";
        if (d != 0 || h != 0 || m != 0)
            formattedTime += m + "m ";
        formattedTime += s + "s";
        
        return  formattedTime;
    }
    
    function makeUserRow(user){
        var cells = "";
        
        var flag = "";
        if (user.location.hasOwnProperty("data") && user.location.data.hasOwnProperty("geo")){
            var countryName = user.location.data.geo.country_name;
            flag = '<img src="https://www.countryflags.io/' + user.location.data.geo.country_code + '/flat/64.png" title="' + countryName + '" height="20px">';
        }
        cells += '<td>' + flag + "</td>";
        
        cells += '<td>' + user.name + "</td>";
        
        cells += '<td>' + timeDisplay(user.secondsOnlineOrOffline*1000) + "</td>";
        
        cells += '<td>' + timeDisplay(user.secondsPlayed*1000) + "</td>";
        
        cells += "<td>Level " + user.level + " " + user.class + "</td>";
        
        var cityText = user.city;
        if (user.isKing)
            cityText = cityText + " <span class='king'>&#x265B;</span>";
        cells += "<td>" + cityText + "</td>";
        
        cells += makeBarCell(user.health, user.maxHealth, "#00CC00");
        
        cells += makeBarCell(user.energy, user.maxEnergy, "#FFCC00");
        
        cells += "<td>" + Math.round(user.x) + ", " + Math.round(user.y) + "</td>";
        
        var gearText = "";
        for (var i = 0; i < user.gear.length; ++i){
            var id = user.gear[i].id;
            var qty = user.gear[i].qty;
            var icon = "<img width='16px'/>";
            if (id != "")
                icon = "<img width='16px' src='../Images/Items/" + id + ".png' title='" + id + "'>";
            gearText += icon;
        }
        cells += "<td>" + gearText + "</td>";
        
        var inventoryText = "";
        for (var i = 0; i < user.inventory.length; ++i){
            var id = user.inventory[i].id;
            var qty = user.inventory[i].qty;
            var icon = "<img width='16px'/>";
            if (id != "")
                icon = "<img width='16px' src='../Images/Items/" + id + ".png' title='" + id + "'>";
            inventoryText += icon;
        }
        cells += "<td>" + inventoryText + "</td>";
        
        cells += makeBarCell(user.chunksExplored, user.chunksTotal, "#659A63");
        cells += makeBarCell(user.completedQuests, stats.quests, "#801A7C");
        cells += makeBarCell(user.knownRecipes, stats.recipes, "#bbb");
        cells += makeBarCell(user.knownConstructions, stats.constructions, "#bbb");
        
        
        return cells;
    }
    
    function makeBarCell(val, max, color){
        return "<td>" + makeBar(val, max, color) + "</td>"
    }
    
    function makeBar(val, max, color){
        var barWRaw = 100;
        var barHRaw = 15;
        var fillWRaw = 1.0 * val / max * 100;
        
        var barW = barWRaw.toString();
        var barH = barHRaw.toString();
        var fillW = fillWRaw.toString();
        var fillH = (barHRaw - 2).toString();
        
        var ret =
            '<svg width="' + barW + '" height="' + barH + '">' +
            '<rect width="' + barW + '" height="' + barH + '" class="barOutline" />' +
            '<rect x="1" y="1" width="' + fillW + '" height="' + fillH + '" style="fill:' + color + '" />' +
            '</svg>'
        return ret;
    }

    $("#version").html(stats.version);
    $("#time").html(timeDisplay(stats.time));
    
    stats.users.sort(function(a, b){
        if (a.online != b.online)
            return a.isOnline ? -1 : 1;
        if (a.online)
            return b.secondsOnlineOrOffline - a.secondsOnlineOrOffline;
        else
            return a.secondsOnlineOrOffline - b.secondsOnlineOrOffline;
            
        return a.name - b.name
    });
    
    for (var i = 0; i < stats.users.length; ++i){
        var classString = "";
        if (!stats.users[i].online) classString = ' class="offline"';
        $("#users").append("<tr" + classString + ">" + makeUserRow(stats.users[i]) + "</tr>");
    }
        
</script>
<script type="text/javascript">
  setTimeout(function () { location.reload(true); }, 2500);
</script>

</html>
